<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <meta name="author" content="Notes by Dan Peirce B.Sc.">
  <title>IIC OLED V1.2</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
  </style>
  <link rel="stylesheet" href="../../pandocbd.css">
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header>
<h1 class="title">IIC OLED V1.2</h1>
<p class="author">Notes by Dan Peirce B.Sc.</p>
</header>
<nav id="TOC">
<ul>
<li><a href="#iic-oled-v1.2-notes">IIC OLED V1.2 Notes</a><ul>
<li><a href="#initial-testing-of-display">Initial Testing of Display</a><ul>
<li><a href="#wiring">Wiring</a></li>
<li><a href="#arduino-ide-setup">Arduino IDE Setup</a></li>
<li><a href="#demo-video">Demo Video</a></li>
<li><a href="#code-used-on-first-day">Code Used on First Day</a></li>
</ul></li>
<li><a href="#switching-to-current-adafruit-libraries-may-20-2018">Switching to Current Adafruit Libraries (May 20, 2018)</a><ul>
<li><a href="#documentation-of-adafruit-graphics-library">Documentation of Adafruit Graphics Library</a></li>
<li><a href="#adjustments-for-3rd-party-display.">Adjustments for 3rd Party Display.</a></li>
<li><a href="#forked-on-github">Forked on Github</a></li>
<li><a href="#explore-text-branch">Explore Text Branch</a></li>
<li><a href="#terminal-branch">Terminal Branch</a></li>
<li><a href="#terminal-branch-with-so">Terminal Branch with SO</a><ul>
<li><a href="#code-for-this-branch">Code for this branch:</a><ul>
<li><a href="#moving-string-literals-to-flash">Moving String Literals to Flash</a></li>
</ul></li>
</ul></li>
<li><a href="#timer-branch">Timer Branch</a><ul>
<li><a href="#tic-tac-toe-branch-merged-in">tic tac toe branch Merged in</a></li>
</ul></li>
<li><a href="#tic-tac-toe-branch">Tic Tac Toe Branch</a><ul>
<li><a href="#code-for-this-branch-1">Code for this branch</a></li>
<li><a href="#command-codes-to-control-the-display-terminal">Command Codes to control the Display Terminal</a></li>
</ul></li>
</ul></li>
<li><a href="#new-target-pro-trinket-5v">New Target Pro Trinket 5v</a></li>
</ul></li>
<li><a href="#applications">Applications</a><ul>
<li><a href="#photogate-timer-repository">Photogate Timer Repository</a><ul>
<li><a href="#pickmode2620">pickmode2620</a><ul>
<li><a href="#stopwatch-mode">Stopwatch mode</a></li>
<li><a href="#photogate">Photogate</a></li>
<li><a href="#pendulum">Pendulum</a></li>
<li><a href="#pulse">Pulse</a></li>
<li><a href="#picket-fence-1">Picket Fence 1</a></li>
</ul></li>
</ul></li>
<li><a href="#historical-notes-before-pickmode2620-was-created">Historical Notes (before pickmode2620 was created)</a><ul>
<li><a href="#justcount">justcount</a><ul>
<li><a href="#power-source">Power Source</a><ul>
<li><a href="#when-programming-the-trinket">When Programming the Trinket</a></li>
<li><a href="#when-receiving-serial-data-from-a-pic-mcu">When Receiving Serial Data from a PIC MCU</a></li>
</ul></li>
<li><a href="#added-a-window-state-to-terminal">Added a Window State to Terminal</a></li>
</ul></li>
<li><a href="#keypress">keypress</a><ul>
<li><a href="#use-of-sprintf-and-a-char-buffer">Use of sprintf and a char buffer</a></li>
<li><a href="#oledterminal.ino-has-been-moved-to-photogatelv.c-repository">oledterminal.ino has been moved to PhotogateLV.c Repository</a></li>
</ul></li>
<li><a href="#switchpresscount">switchpresscount</a></li>
<li><a href="#timeswitch">timeswitch</a><ul>
<li><a href="#code-for-timewswitch">Code for timewswitch</a></li>
<li><a href="#simple-simulation-of-photogate">Simple Simulation of Photogate</a><ul>
<li><a href="#notes-on-the-trinket-m0">Notes on the Trinket M0</a></li>
</ul></li>
<li><a href="#renamed-main-file">Renamed main File</a><ul>
<li><a href="#branches-graphic">Branches Graphic</a></li>
</ul></li>
</ul></li>
<li><a href="#timegateosc">timegateosc</a></li>
<li><a href="#stopwatch">stopwatch</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
<h1 id="iic-oled-v1.2-notes">IIC OLED V1.2 Notes</h1>
<p>The display was purchased from the Canadian version of the RobotShop website:</p>
<ul>
<li><a href="https://www.robotshop.com/ca/en/iic-128-64-oled-module-blue.html" class="uri">https://www.robotshop.com/ca/en/iic-128-64-oled-module-blue.html</a></li>
</ul>
<p>Unfortunately they don't provide up to date information for the OLED module. The datasheet is for a previous version. The Libraries supplied for the display are written by Adafruit.</p>
<figure>
<img src="explore_text.png" />
</figure>
<h2 id="initial-testing-of-display">Initial Testing of Display</h2>
<h3 id="wiring">Wiring</h3>
<p>Initial testing was done with an Ardunino Uno as this was what was shown in the datasheet. Note the silkscreen on the v1.2 board does not match the v1.1 datasheet with regard to the pinout. I followed the silkscreen.</p>
<ul>
<li>Pin Vcc to Arduino Uno 5+</li>
<li>Pin ground to Arduino Uno ground</li>
<li>cl to Arduino Uno A5</li>
<li>data to Arduiono Uno A4</li>
</ul>
<p>No external pull ups were added!</p>
<h3 id="arduino-ide-setup">Arduino IDE Setup</h3>
<ol type="1">
<li><p>Downloaded and installed Arduino IDE for windows 7. (used installer for XP and up)</p>
<ul>
<li><a href="https://www.arduino.cc/en/Main/Software" class="uri">https://www.arduino.cc/en/Main/Software</a></li>
</ul></li>
<li><p>Downloaded libraries from elecfreaks site.</p>
<ul>
<li><a href="https://elecfreaks.com/estore/download/EF03155-Paintcode.zip" class="uri">https://elecfreaks.com/estore/download/EF03155-Paintcode.zip</a></li>
<li><a href="https://www.elecfreaks.com/estore/iic-oled.html" class="uri">https://www.elecfreaks.com/estore/iic-oled.html</a></li>
</ul>
<p>The libraries are actually from Adafruit. One can learn more about them here:</p>
<ul>
<li><a href="https://learn.adafruit.com/monochrome-oled-breakouts/arduino-library-and-examples" class="uri">https://learn.adafruit.com/monochrome-oled-breakouts/arduino-library-and-examples</a></li>
</ul></li>
<li>Extracted files/folders from zip file.</li>
<li><p>Two folders containing files were copied to c:\arduino\libraries</p></li>
</ol>
<pre><code>  C:\Users\Student\Downloads\EF03155-Paintcode\Code\Arduino_UNO_DEOM\Hardware I2C\Adafruit_GFX
  C:\Users\Student\Downloads\EF03155-Paintcode\Code\Arduino_UNO_DEOM\Hardware I2C\Adafruit_SSD1306</code></pre>
<ol start="5" type="1">
<li><p>A new example became available in the IDE</p>
<figure>
<img src="adafruit_ssd1306_example.png" />
</figure>
<p>The example was copied and pasted into a new sketch.</p></li>
<li><p>Initially the sketch would not compile. The compiler error indicated that a variable needed to be a constant to be placed in program memory. The following line was changed (line appears just after macro definitions near beginning of file).</p>
<ul>
<li><em>was --</em> static unsigned char PROGMEM logo16_glcd_bmp[] =</li>
<li><em>changed to --</em> static const unsigned char PROGMEM logo16_glcd_bmp[] =</li>
</ul>
<p>Once the <strong>const</strong> reserved word was added the sketch compiled.</p></li>
<li><p>The display still remained blank. An I<sup>2</sup>C scanner Arduino sketch was used to find that the board responded to the address <strong>0x3C</strong>. A line in the example was changed to include this address. Once this was done the display showed the example code.</p>
<ul>
<li>display.begin(SSD1306_SWITCHCAPVCC, 0x3C);</li>
</ul></li>
<li><p>Other modifications were made as I was interested in concentrating on the display of text rather than graphics.</p></li>
</ol>
<h3 id="demo-video">Demo Video</h3>
<p>This was recorded at the end of the day in a rush. I expect to get a better quality video soon -- it looks better in person. Also I will do some testing of different text sizes.</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/nSQjUFMyLBs" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen>
</iframe>
<h3 id="code-used-on-first-day">Code Used on First Day</h3>
<p>Code moved to new file to avoid clutter on this page.</p>
<ul>
<li><a href="ssd1306_128x64_i2c.ino.html" class="uri">ssd1306_128x64_i2c.ino.html</a></li>
</ul>
<h2 id="switching-to-current-adafruit-libraries-may-20-2018">Switching to Current Adafruit Libraries (May 20, 2018)</h2>
<p>It became apparent that the elecfreaks.com site provided an old version of the libraries and it seemed expedient to test the current version of the files.</p>
<p>It worked with a minor adjustment for the electfreak display.</p>
<h3 id="documentation-of-adafruit-graphics-library">Documentation of Adafruit Graphics Library</h3>
<ul>
<li><a href="https://learn.adafruit.com/adafruit-gfx-graphics-library?view=all" class="uri">https://learn.adafruit.com/adafruit-gfx-graphics-library?view=all</a></li>
</ul>
<h3 id="adjustments-for-3rd-party-display.">Adjustments for 3rd Party Display.</h3>
<ol type="1">
<li><p>As before the address of the display had to be adjusted.</p>
<ul>
<li>display.begin(SSD1306_SWITCHCAPVCC, 0x3C); // was 0x3D</li>
</ul></li>
<li><p>Had to make a change to Adafruit_SSD1306.had</p>
<p>At line 73 changed which line was commented out.</p></li>
</ol>
<div class="sourceCode"><pre class="sourceCode c"><code class="sourceCode c">   <span class="pp">#define SSD1306_128_64</span>
<span class="co">//   #define SSD1306_128_32</span>
<span class="co">//   #define SSD1306_96_16</span></code></pre></div>
<h3 id="forked-on-github">Forked on Github</h3>
<p>I forked the project on Github and made a new branch called 3rdparty.</p>
<ul>
<li><a href="https://github.com/danpeirce/Adafruit_SSD1306/tree/3rdparty" class="uri">https://github.com/danpeirce/Adafruit_SSD1306/tree/3rdparty</a></li>
<li><a href="https://github.com/adafruit/Adafruit_SSD1306/compare/master...danpeirce:3rdparty" class="uri">https://github.com/adafruit/Adafruit_SSD1306/compare/master...danpeirce:3rdparty</a></li>
</ul>
<h3 id="explore-text-branch">Explore Text Branch</h3>
<p>Added a new branch to fork of Adafruit_SSD1306 repository Called exploring_text.</p>
<ul>
<li><a href="https://github.com/danpeirce/Adafruit_SSD1306/blob/explore_text/examples/explore_text/explore_text.ino" class="uri">https://github.com/danpeirce/Adafruit_SSD1306/blob/explore_text/examples/explore_text/explore_text.ino</a></li>
</ul>
<figure>
<img src="explore_text.png" />
</figure>
<h3 id="terminal-branch">Terminal Branch</h3>
<p>Added a new branch to fork of Adafruit_SSD1306 called terminal. The intent is to be able to send serial strings to the Arduino that will act as a controller for the display. The stream of characters could come from any MCU which would not need the graphics library ported. Current testing is being done with Arduino serial monitor but will follow up with project MCU.</p>
<ol type="1">
<li>Runs Adafruit splash screen followed by Hello World KPU PHYS1600. It then waits for input and blanks the screen when input received, then shows text in top left of screen.</li>
<li>Display wraps to start of next line if it runs out of room on current line. In addition a newline character will also send the cursor to beginning of next line.</li>
<li>If too many rows of text are received new text is not visible.</li>
<li>Intercepts a number of ASCII control codes and calls a corresponding library function. The number of codes may be expanded.</li>
<li>To facilitate testing a Processing sketch has been written that is capable of both sending regular text and generating the control characters when select non-alphanumeric characters are used.</li>
</ol>
<figure>
<img src="test-oled.png" />
</figure>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"> display.setRotation(<span class="dv">1</span>); <span class="co">// results in a portrait orientation for text on the screen</span></code></pre></div>
<ul>
<li><a href="https://github.com/danpeirce/Adafruit_SSD1306/blob/terminal/examples/explore_text/explore_text.ino" class="uri">https://github.com/danpeirce/Adafruit_SSD1306/blob/terminal/examples/explore_text/explore_text.ino</a></li>
</ul>
<figure>
<img src="rotate-display.png" />
</figure>
<h3 id="terminal-branch-with-so">Terminal Branch with SO</h3>
<p>Added a new branch with SO (shift out) support. To facilitate multiple SO commands the sketch/program was converted to a state machine structure. This permits the ability to add parameters to a command. The set text position command for example requires X and Y coordinates as parameters for setting the cursor position.</p>
<figure>
<img src="test-oled-so.png" alt="test-oled-so.png" /><figcaption>test-oled-so.png</figcaption>
</figure>
<h4 id="code-for-this-branch">Code for this branch:</h4>
<ul>
<li><a href="https://github.com/danpeirce/Adafruit_SSD1306/blob/terminal_so/examples/explore_text/explore_text.ino" class="uri">https://github.com/danpeirce/Adafruit_SSD1306/blob/terminal_so/examples/explore_text/explore_text.ino</a></li>
<li><a href="https://github.com/danpeirce/Adafruit_SSD1306/blob/terminal_so/examples/explore_text/sketch_180522a_test_oled/sketch_180522a_test_oled.pde" class="uri">https://github.com/danpeirce/Adafruit_SSD1306/blob/terminal_so/examples/explore_text/sketch_180522a_test_oled/sketch_180522a_test_oled.pde</a></li>
</ul>
<p>As of the time of this entry (June 6, 2018) The font has been changed to the 9 point Serif font. This font is easier to read than the built in font.</p>
<ul>
<li><em>an image of display with serif font will be added when time permits</em>.</li>
</ul>
<h5 id="moving-string-literals-to-flash">Moving String Literals to Flash</h5>
<p>To save RAM space the F() macro is being used with string literals. This conserves RAM. (June 17, 2018)</p>
<h3 id="timer-branch">Timer Branch</h3>
<p>A new branch was added which differs from terminal_so primarily in the look of the start screen.</p>
<figure>
<img src="photogateTimer.jpg" />
</figure>
<ul>
<li><a href="https://github.com/danpeirce/Adafruit_SSD1306/blob/timer/examples/explore_text/explore_text.ino" class="uri">https://github.com/danpeirce/Adafruit_SSD1306/blob/timer/examples/explore_text/explore_text.ino</a></li>
</ul>
<p>The code in the <strong>setup()</strong> function was simplified by breaking out lines responsible for the start screen into a separate function. A SO command was added so that this function can be called again after the screen is cleared. This refactoring will be merged back into the timer_so branch.</p>
<figure>
<img src="test-oled-timer.png" />
</figure>
<h4 id="tic-tac-toe-branch-merged-in">tic tac toe branch Merged in</h4>
<p>The tictactoe branch was merged into the timer branch to take advantage of new features. The essential difference now is in the default screen.</p>
<h3 id="tic-tac-toe-branch">Tic Tac Toe Branch</h3>
<p>Tic tac toe branch allows easy setup of Tic Tac Toe screens for play.</p>
<figure>
<img src="tictactoe.jpg" />
</figure>
<p>The next image shows the numbered positions corresponding to the nine positions that an X or and O can be placed. The numbers are added with the sequence: <strong>&quot;&amp;ts&quot;</strong></p>
<figure>
<img src="tictactoepos.jpg" />
</figure>
<p>The next image shows an example.</p>
<ul>
<li>An X is put in position &quot;1&quot; with the sequence: <strong>&quot;&amp;t1X&quot; enter</strong></li>
<li>The O is placed with the sequence: <strong>&quot;&amp;t9O&quot; enter</strong></li>
</ul>
<p>The sequence shown above was typed into the Processing sketch. Note that the &quot;&amp;&quot; is not sent as is to the &quot;terminal&quot; but is used in the sketch as it is easy to type. If one were writing a PIC program a 0x0E would be sent for the Shift Out command.</p>
<figure>
<img src="tictactoeXO.jpg" />
</figure>
<p>Menu items for Tic Tac Toe have been added for testing.</p>
<figure>
<img src="test-oled-tictactoe.png" />
</figure>
<h4 id="code-for-this-branch-1">Code for this branch</h4>
<ul>
<li><a href="https://github.com/danpeirce/Adafruit_SSD1306/blob/tictactoe/examples/explore_text/explore_text.ino" class="uri">https://github.com/danpeirce/Adafruit_SSD1306/blob/tictactoe/examples/explore_text/explore_text.ino</a></li>
<li><a href="https://github.com/danpeirce/Adafruit_SSD1306/blob/tictactoe/examples/explore_text/sketch_180522a_test_oled/sketch_180522a_test_oled.pde" class="uri">https://github.com/danpeirce/Adafruit_SSD1306/blob/tictactoe/examples/explore_text/sketch_180522a_test_oled/sketch_180522a_test_oled.pde</a></li>
</ul>
<h4 id="command-codes-to-control-the-display-terminal">Command Codes to control the Display Terminal</h4>
<p>In the default state most ASCII characters sent will be printed if printable but do not appear on display until a newline/linefeed &quot;&quot; is sent (0x0A).</p>
<ul>
<li>Default state
<ul>
<li><strong>0x0C</strong> is an ASCII Form Feed and will be used for <strong>Clear Screen</strong>
<ul>
<li>if using Processing sketch use &quot;~&quot; to send 0x0C</li>
</ul></li>
<li><strong>0x11</strong> is an ASCII Device Control 1 and will be used for <strong>Text Size 1</strong>
<ul>
<li>if using Processing sketch use &quot;!&quot; to send 0x11</li>
</ul></li>
<li><strong>0x12</strong> is an ASCII Device Control 2 and will be used for <strong>Text Size 2</strong>
<ul>
<li>if using Processing sketch use &quot;@&quot; to send 0x12</li>
</ul></li>
<li><strong>0x13</strong> is an ASCII Device Control 3 and will be used for <strong>Text Size 3</strong>
<ul>
<li>if using Processing sketch use &quot;#&quot; to send 0x13</li>
</ul></li>
<li><strong>0x14</strong> is an ASCII Device Control 4 and will be used for <strong>Text Size 4</strong>
<ul>
<li>if using Processing sketch use &quot;$&quot; to send 0x14</li>
</ul></li>
<li><strong>0x09</strong> is an ASCII Horizontal Tab and will be used for <strong>Landscape Mode</strong>
<ul>
<li>if using Processing sketch use &quot;%&quot; to send 0x09</li>
</ul></li>
<li><strong>0x0B</strong> is an ASCII Vertical Tab and will be used for <strong>Portrait Mode</strong>
<ul>
<li>if using Processing sketch use &quot;^&quot; to send 0x0B</li>
</ul></li>
<li><strong>0x0E</strong> is an ASCII Shift Out and will be used for <strong>Control Mode</strong>
<ul>
<li>if using Processing sketch use &quot;&amp;&quot; to send 0x0E</li>
<li>do not add newline</li>
</ul></li>
</ul></li>
<li>Shift Out state <strong>Control Mode</strong>
<ul>
<li>A <strong>Back Tick</strong> &quot;`&quot; is used for <strong>Set Text Position Mode</strong>
<ul>
<li>expects a byte for X position and a byte for Y position for text insertion position
<ul>
<li>decimal 0x20 will be subtracted if the value is greater 0x20 or greater so that any binary value can be typed from a terminal</li>
<li>do not add newline</li>
</ul></li>
</ul></li>
<li>A <strong>Hyphen</strong> &quot;-&quot; is used for <strong>Draw Line Mode</strong>
<ul>
<li>expects four bytes for two endpoints
<ul>
<li>byte order x1,y1,x2,y2</li>
<li>decimal 0x20 will be subtracted if the value is greater 0x20 or greater so that any binary value can be typed from a terminal</li>
<li>do not add newline</li>
</ul></li>
</ul></li>
<li>A <strong>'f'</strong> is used for <strong>Set Font</strong>
<ul>
<li><strong>'0'</strong> internal font</li>
<li><strong>'1'</strong> 9pnt Serif font
<ul>
<li>do not add newline</li>
</ul></li>
</ul></li>
<li>A <strong>'p'</strong> is used for <strong>Show Photogate Timer</strong> start screen</li>
<li>A <strong>'t'</strong> is used for <strong>Tic Tac Toe</strong>
<ul>
<li><strong>'1' to '9'</strong> is used to set area for entry</li>
<li><strong>'s'</strong> is used for <strong>Show Position</strong> used to show position codes/labels</li>
<li><strong>'d'</strong> is used for <strong>Delete Entry</strong>
<ul>
<li><strong>'1' to '9'</strong> is used to set area for deletion</li>
</ul></li>
</ul></li>
<li>A <strong>'r'</strong> is used for <strong>Revert to Start Screen</strong></li>
</ul></li>
</ul>
<h2 id="new-target-pro-trinket-5v">New Target Pro Trinket 5v</h2>
<p>On May 28, 2018 moved testing from Arduino Uno to Adafruit Pro Trinket 5 volts. This board is much like the Uno when combined with a USB to serial adaptor board. The Arduino IDE sees the combination as the same as a Arduino Uno. The Pro Trinket will shrink the size of the project and reduce cost. The final project will not need the USB to serial adaptor board attached which will further reduce cost when we make a class set. I will continue to use the USB to serial board for programming and testing only.</p>
<ul>
<li><a href="https://www.digikey.ca/product-detail/en/adafruit-industries-llc/2000/1528-1039-ND/4990788" class="uri">https://www.digikey.ca/product-detail/en/adafruit-industries-llc/2000/1528-1039-ND/4990788</a></li>
</ul>
<figure>
<img src="proTrinket5-oled.jpg" />
</figure>
<h1 id="applications">Applications</h1>
<h2 id="photogate-timer-repository">Photogate Timer Repository</h2>
<h3 id="pickmode2620">pickmode2620</h3>
<p>The pickmode2620 branch allows selection of different operating modes.</p>
<ol type="1">
<li>Stopwatch</li>
<li>Photogate
<ol type="a">
<li>continual update</li>
<li>keep first time measured</li>
</ol></li>
<li>Pendulum</li>
<li>Pulse</li>
<li>Picket Fence 1</li>
</ol>
<p>The descriptions at <a href="https://github.com/danpeirce/photogate-box-ssd1306term" class="uri">https://github.com/danpeirce/photogate-box-ssd1306term</a> are updated more frequently than the descriptions of the modes found here.</p>
<p>When the timer box is powered up window 1 of the display will cycle displaying possible mode selections in a repeating sequence. The <strong>mode select</strong> button allows one to select the mode.</p>
<p>The pickmode2620 differs from the pickmode branch in thaat it was updated for the PIC18F2620. The project was started on a breadboard using a PIC18F4525 as it happened to be available. The intent was to use the PIC18F2620 on the final project as it is physically smaller.</p>
<h4 id="stopwatch-mode">Stopwatch mode</h4>
<p>When the Stopwatch mode is selected the <strong>mode select</strong> button becomes the Start/Stop button. During timing window 2 of the display shows <strong>- - -</strong>. When timing is stopped the time will be displayed in window 2. Time is reset automatically if/when the Start/Stop button is pressed again. The Mode Reset button will restart the timer with window 1 cycling the available modes.</p>
<h4 id="photogate">Photogate</h4>
<p>The Photogate mode will time the duration between negative going edges on the photogate1 input.</p>
<h4 id="pendulum">Pendulum</h4>
<p>The Pendulum mode is similar to Photogate mode but is displays the total period of a swinging pendulum.</p>
<h4 id="pulse">Pulse</h4>
<p>The Pulse mode times the duration from falling edge to rising edge. Currently this mode runs once and returns to the mode selection state with the time displayed in window 2.</p>
<h4 id="picket-fence-1">Picket Fence 1</h4>
<p>This mode measures the duration between the first falling edge (the trigger point) and each of eight subsequent falling edges. None of the times are displayed until they have all been recorded. The display will then continuously cycle through and display each time.</p>
<h2 id="historical-notes-before-pickmode2620-was-created">Historical Notes (before pickmode2620 was created)</h2>
<p>The old Git PIC MCU photogate box repository was imported into a new repository and will be modified to make use of the graphics display terminal.</p>
<ul>
<li><a href="https://github.com/danpeirce/photogate-box-ssd1306term#photogate-box" class="uri">https://github.com/danpeirce/photogate-box-ssd1306term#photogate-box</a></li>
</ul>
<h3 id="justcount">justcount</h3>
<p>A simple exploratory project that combines a PIC MCU with the OLED terminal. This is essentially my first experiment in using the <strong>Pro 5+ Volt Trinket -- OLED graphics display</strong> combo as a <strong>display terminal</strong> for a <strong>PIC project</strong>.</p>
<ul>
<li><a href="https://github.com/danpeirce/photogate-box-ssd1306term/tree/justcount" class="uri">https://github.com/danpeirce/photogate-box-ssd1306term/tree/justcount</a></li>
</ul>
<p>The Circuit with the PIC18F4525 and Display Terminal <img src="justcountcct.jpg" alt="The Circuit with the PIC18F4525 and Display Terminal" /></p>
<figure>
<img src="justcount.jpg" />
</figure>
<h4 id="power-source">Power Source</h4>
<p>There are several possible methods of powering the Pro Trinket board which distributes power to the rest of the project.</p>
<h5 id="when-programming-the-trinket">When Programming the Trinket</h5>
<p>The Pro 5+Volt Trinket board was powered from a USB to serial adapter board that was also used to program the Trinket.</p>
<h5 id="when-receiving-serial-data-from-a-pic-mcu">When Receiving Serial Data from a PIC MCU</h5>
<p>The adapter is removed and power comes through a Micro B USB connector in the Trinket. V<sub>DD</sub> and ground is being distributed to the PIC MCU and the OLED display from the Trinket.</p>
<p>There is a jumper from the PIC Tx pin to the Trinket board Rx.</p>
<h4 id="added-a-window-state-to-terminal">Added a Window State to Terminal</h4>
<p>In an effort to eliminate flicker that was evident in the count line on the display a window state was created. There is no call to <strong>display.display()</strong> until a newline is received.</p>
<ul>
<li>The window state looks for a numeral input indicating which window to clear and print into. So far only one window has been defined and named '2'.</li>
<li><strong>window2</strong> is the area below the lower line of the Photogate Timer heading.
<ul>
<li>There is an intent to define window1 as the area of the heading.</li>
<li>There is an intent to define window3 as the space to the right that includes KPU.</li>
</ul></li>
</ul>
<p>The main while loop running in the PIC for <strong>justcount</strong> is very simple. The count is free running and the time per cycle is not a prime consideration.</p>
<div class="sourceCode"><pre class="sourceCode c"><code class="sourceCode c">    <span class="cf">while</span>(<span class="dv">1</span>)
    { 
        count++;
        <span class="cf">if</span> (count &gt; <span class="dv">500000</span>)
        {
            <span class="dt">static</span> <span class="dt">unsigned</span> <span class="dt">int</span> cycle = <span class="dv">0</span>; 
            <span class="dt">static</span> <span class="dt">const</span> <span class="dt">char</span> code[] = {SHIFTOUT, <span class="ch">&#39;w&#39;</span>, <span class="ch">&#39;2&#39;</span>, <span class="dv">0</span>};
            count = <span class="dv">0</span>;
            printf(<span class="st">&quot;%s&gt; %d</span><span class="sc">\n</span><span class="st">&quot;</span>, code, cycle);
            cycle++;
        }
    }</code></pre></div>
<h3 id="keypress">keypress</h3>
<p>This branch explores posting a message to the display that indicates if a pushbutton switch has been pressed or released.</p>
<figure>
<img src="https://raw.githubusercontent.com/danpeirce/photogate-box-ssd1306term/keypress/image/keypress.jpg" />
</figure>
<figure>
<img src="https://raw.githubusercontent.com/danpeirce/photogate-box-ssd1306term/keypress/image/keyrelease.jpg" />
</figure>
<h4 id="use-of-sprintf-and-a-char-buffer">Use of sprintf and a char buffer</h4>
<p>Since printf() does not return until all but the last two characters are sent it generally causes delays. Those delays could result in missed key presses. To avoid that issue sprintf() is being used rather than printf().</p>
<div class="sourceCode"><pre class="sourceCode c"><code class="sourceCode c">        keyp = PORTDbits.RD2;
        <span class="cf">if</span> (keyp != keyplast)
        {
            <span class="cf">if</span> (keyp == <span class="dv">1</span>) 
            {
                inIndexBuff = inIndexBuff + sprintf( buffer+inIndexBuff, <span class="st">&quot;%sKey Press</span><span class="sc">\n</span><span class="st">&quot;</span>, code);
                
            }
            <span class="cf">else</span> 
            {
                inIndexBuff = inIndexBuff + sprintf( buffer+inIndexBuff,<span class="st">&quot;%sKey Release</span><span class="sc">\n</span><span class="st">&quot;</span>, code);
            }
        }
        keyplast = keyp;</code></pre></div>
<p>There is also a task to send a byte to the USART whenever it is ready for one if the buffer is not empty..</p>
<div class="sourceCode"><pre class="sourceCode c"><code class="sourceCode c">        <span class="cf">if</span>(TXIF &amp;&amp; (inIndexBuff &gt; <span class="dv">0</span>))
        {
            TXREG = buffer[outIndexBuff];
            outIndexBuff++;
            <span class="cf">if</span> (inIndexBuff == outIndexBuff) 
            {
                inIndexBuff = <span class="dv">0</span>;
                outIndexBuff= <span class="dv">0</span>;
            }
        }</code></pre></div>
<p>After speeding up the loop significant switch bounce became apparent. This was mitigated by reducing the frequency of checking the switch condition.</p>
<div class="sourceCode"><pre class="sourceCode c"><code class="sourceCode c">    <span class="cf">while</span>(<span class="dv">1</span>)
    {  
        <span class="dt">static</span> <span class="dt">int</span> loopcount=<span class="dv">0</span>;
        <span class="cf">if</span> (loopcount &gt; <span class="dv">500</span>)
        {
            keypresstask();
            loopcount=<span class="dv">0</span>;
        }
        loopcount++;
        txbuffertask();
    } </code></pre></div>
<h4 id="oledterminal.ino-has-been-moved-to-photogatelv.c-repository">oledterminal.ino has been moved to PhotogateLV.c Repository</h4>
<p>It seemed more practical to have a copy of the terminal sketch in the PhotogateLC.c repository.</p>
<h3 id="switchpresscount">switchpresscount</h3>
<p>This branch counts the number of times a button switch has been pressed. This could be useful to ensure switch bounce has been deal with adequately.</p>
<p><em>place image</em></p>
<h3 id="timeswitch">timeswitch</h3>
<figure>
<img src="https://raw.githubusercontent.com/danpeirce/photogate-box-ssd1306term/timeswitch/image/timeswitchsec.jpg" />
</figure>
<p>This branch was initially intended to time the interval between key presses. It became apparent testing would be more consistent if a photogate were simulated with a digital signal from another MCU. A <strong>Trinket M0</strong> was available and used for this purpose.</p>
<figure>
<img src="https://raw.githubusercontent.com/danpeirce/photogate-box-ssd1306term/timeswitch/image/timeswitchcct.jpg" />
</figure>
<h4 id="code-for-timewswitch">Code for timewswitch</h4>
<p>The code for this branch is on Github.</p>
<ul>
<li><a href="https://github.com/danpeirce/photogate-box-ssd1306term/tree/timeswitch" class="uri">https://github.com/danpeirce/photogate-box-ssd1306term/tree/timeswitch</a></li>
</ul>
<h4 id="simple-simulation-of-photogate">Simple Simulation of Photogate</h4>
<p>The Trinket M0 code used to generate a period of about 20 seconds.</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">// the setup function runs once when you press reset or power the board</span>
<span class="dt">void</span> setup() {
  <span class="co">// initialize digital pin 13 as an output.</span>
  pinMode(<span class="dv">13</span>, OUTPUT);
  pinMode(<span class="dv">0</span>, OUTPUT);
}

<span class="co">// the loop function runs over and over again forever</span>
<span class="dt">void</span> loop() {
  digitalWrite(<span class="dv">13</span>, HIGH);   <span class="co">// turn the LED on (HIGH is the voltage level)</span>
  digitalWrite(<span class="dv">0</span>, HIGH);
  delay(<span class="dv">10000</span>);              <span class="co">// wait for 10 seconds</span>
  digitalWrite(<span class="dv">13</span>, LOW);    <span class="co">// turn the LED off by making the voltage LOW</span>
  digitalWrite(<span class="dv">0</span>, LOW);
  delay(<span class="dv">10000</span>);              <span class="co">// wait for 10 seconds</span>
}</code></pre></div>
<h5 id="notes-on-the-trinket-m0">Notes on the Trinket M0</h5>
<p>Notes on the Trinket M0 at link:</p>
<ul>
<li><a href="https://danpeirce.github.io/2017/testTrinketM0/testing.html" class="uri">https://danpeirce.github.io/2017/testTrinketM0/testing.html</a></li>
</ul>
<h4 id="renamed-main-file">Renamed main File</h4>
<p>It was decided to rename the main file of the project and move unused functions to a different file. This change has now been cherry picked and merged into older branches.</p>
<h5 id="branches-graphic">Branches Graphic</h5>
<figure>
<img src="branches01.png" />
</figure>
<ul>
<li><p>The hash that was cherry picked from is given below:</p>
<ul>
<li>&lt;3962c9e44e09b1ef240829ac2531e926d5549208&gt;</li>
</ul></li>
</ul>
<h3 id="timegateosc">timegateosc</h3>
<p>This branch was derived from <a href="#timeswitch">timeswitch</a>. The code was altered to work with an external 32 MHz rather than the internal oscillator used initially.</p>
<p>Watch for updates to this page.</p>
<h3 id="stopwatch">stopwatch</h3>
<p>This branch was derived from <a href="#timegateosc">timegateosc</a>. The code was altered to time between start and stop button presses. This branch ignores the simulated photogate on the CCP1 input. The follow up branch will create a mode select to allow one to choose either mode of operation.</p>
<p>The function main() looks like this now:</p>
<div class="sourceCode"><pre class="sourceCode c"><code class="sourceCode c"><span class="dt">void</span> main(<span class="dt">void</span>)
{
    <span class="dt">char</span> gate_mode = <span class="dv">0</span>;
    Delay10KTCYx(<span class="dv">20</span>); 
  
    initialization();
    debounceSW.a_byte = <span class="dv">0</span>;
    inputSW.a_byte = <span class="dv">0</span>;
    
    <span class="cf">while</span>(<span class="dv">1</span>)
    { 
        <span class="dt">static</span> <span class="dt">unsigned</span> <span class="dt">int</span> listTmr[] = {<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>};
        <span class="dt">static</span> <span class="dt">unsigned</span> <span class="dt">int</span> indexTmr = <span class="dv">0</span>;
        <span class="dt">static</span> <span class="dt">unsigned</span> <span class="dt">int</span> cyclecount = <span class="dv">0</span>;
        
        <span class="cf">if</span>(TXIF &amp;&amp; (inIndexBuff &gt; <span class="dv">0</span>)) txbuffertask();
        <span class="cf">if</span> (PIR1bits.TMR1IF) <span class="co">// Timer1 clock has overflowed</span>
        {
            PIR1bits.TMR1IF = <span class="dv">0</span>; <span class="co">// reset Timer1 clock interrupt flag</span>
            timerCountOvrF++;
        }
        inputSW.bit0 = PORTDbits.RD2;
        <span class="cf">if</span> (!debounceSW.bit0)
        {
            <span class="cf">if</span> (!inputSW.bit0 &amp;&amp; (cyclecount&gt;<span class="dv">2</span>)) cyclecount--;
            <span class="cf">if</span> (inputSW.bit0) 
            {
                cyclecount++;
                <span class="cf">if</span> (cyclecount == <span class="dv">1</span>)
                {
                    listTmr[indexTmr] = ReadTimer1();
                    indexTmr++;
                    listTmr[indexTmr] = timerCountOvrF;
                    indexTmr++;
                    running();
                }
            }
            <span class="cf">if</span> (cyclecount &gt; <span class="dv">100</span>)
            {
                cyclecount = <span class="dv">0</span>;
                debounceSW.bit0 = <span class="dv">1</span>;
            }
        }
        <span class="cf">else</span>
        {
            <span class="cf">if</span> (inputSW.bit0 &amp;&amp; (cyclecount&gt;<span class="dv">2</span>)) cyclecount--;
            <span class="cf">if</span> (!inputSW.bit0) cyclecount++;
            <span class="cf">if</span> (cyclecount &gt; <span class="dv">100</span>) 
            {
                cyclecount = <span class="dv">0</span>;
                debounceSW.bit0 =<span class="dv">0</span>;
            }
        }
        <span class="co">/* if (PIR1bits.CCP1IF)</span>
<span class="co">        {</span>
<span class="co">            listTmr[indexTmr] = ReadCapture1();</span>
<span class="co">            indexTmr++;</span>
<span class="co">            listTmr[indexTmr] = timerCountOvrF;</span>
<span class="co">            indexTmr++;</span>
<span class="co">            PIR1bits.CCP1IF = 0; //clear flag for next event</span>
<span class="co">        } */</span>
        <span class="cf">if</span> (indexTmr == <span class="dv">4</span>) 
        {    
            sendTime(listTmr);
            indexTmr = <span class="dv">0</span>;
            timerCountOvrF = <span class="dv">0</span>;
        }
    } 
}</code></pre></div>
<!---
use 
  pandoc -s --toc --toc-depth=5 -t html5 -c ../../pandocbd.css oled-v1.2.md -o oled-v1.2.html
  pandoc -t markdown_github -s --toc --toc-depth=5 -o readme.md oled-v1.2.md
-->
</body>
</html>
