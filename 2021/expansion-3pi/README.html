<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="By Dan Peirce B.Sc." />
  <title>Pololu 3Pi Expansion</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <link rel="stylesheet" href="../../pandocbd.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">Pololu 3Pi Expansion</h1>
<p class="author">By Dan Peirce B.Sc.</p>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#pololu-3pi-expansion">Pololu 3Pi Expansion</a>
<ul>
<li><a href="#pic18f46k42-xpress-board-features">PIC18F46K42 XPRESS Board Features</a>
<ul>
<li><a href="#pins-used">Pins Used</a></li>
</ul></li>
<li><a href="#pololu-3pi-robot">Pololu 3Pi robot</a>
<ul>
<li><a href="#roam-mode">Roam Mode</a></li>
<li><a href="#no-roam-mode">No Roam Mode</a></li>
</ul></li>
<li><a href="#mounting-pic-xpress-board-on-3pi-expansion-board">Mounting PIC XPRESS board on 3Pi Expansion board</a>
<ul>
<li><a href="#mount-1-no-longer-used">Mount 1 (no longer used)</a></li>
<li><a href="#mount-2">Mount 2</a></li>
</ul></li>
<li><a href="#expansion-board-wiring">Expansion Board Wiring</a></li>
<li><a href="#programming-3pi-robot-as-a-slave">Programming 3Pi Robot as a Slave</a>
<ul>
<li><a href="#image-of-the-pololu-programmer-connected-to-the-3pi">Image of the Pololu Programmer Connected to the 3Pi</a></li>
<li><a href="#using-atmel-studio">Using Atmel Studio</a></li>
</ul></li>
<li><a href="#programming-xpress-board">Programming Xpress Board</a>
<ul>
<li><a href="#pololu3pi.h">pololu3pi.h</a></li>
</ul></li>
<li><a href="#roam-and-no-roam-shunt-jumper">Roam and No Roam Shunt Jumper</a></li>
<li><a href="#autocalibrates-when-in-roam-mode">Autocalibrates when in Roam mode</a></li>
<li><a href="#demo">Demo</a></li>
<li><a href="#pull-up-on-rx2rb7">Pull up on RX2/RB7</a></li>
<li><a href="#charging-circuit">Charging Circuit</a></li>
<li><a href="#added-print-sensor-values-to-menu">Added Print Sensor Values to menu</a></li>
<li><a href="#working-with-putty-and-issues">Working with PuTTY and issues</a></li>
<li><a href="#test-of-expansion-board">Test of Expansion Board</a></li>
</ul></li>
</ul>
</nav>
<!---
use 
pandoc -s --toc -t html5 -c ../../pandocbd.css README.pandoc.md -o README.html

pandoc -s --toc -t gfm README.pandoc.md -o README.md
-->
<h1 id="pololu-3pi-expansion">Pololu 3Pi Expansion</h1>
<h2 id="pic18f46k42-xpress-board-features">PIC18F46K42 XPRESS Board Features</h2>
<p>This board has a USB microB connector. It has a PIC MCU on board configured to act as an interface and it enumerates as a multifunction device. This allows one to both download programs to it and use the interface as a virtual com port. The board is also less expensive than the USB to serial board we have used in the past with the Microstick II or PIC18F4525.</p>
<h3 id="pins-used">Pins Used</h3>
<p><img src="images/pins.png" /></p>
<ul>
<li>UART1 is at 115200 baud. Tx1 is on RC6.</li>
<li>UART2 is connected to the XPRESS boards USB interface PIC.
<ul>
<li>Communication between UART2 and the interface IC is at 9600 baud.</li>
</ul></li>
<li>roam input used to determine if robot should
<ol type="1">
<li>Stay in place (perhaps for programming)</li>
<li>Roam (perhaps following a line)</li>
</ol></li>
<li>PWM output at about 1 KHz on pad RC4 (set to 10% duty cycle)</li>
</ul>
<h2 id="pololu-3pi-robot">Pololu 3Pi robot</h2>
<p>The robot is running the serial slave program from Pololu. This will allow the 3Pi robot to be controlled from a XPRESS board.</p>
<ul>
<li><a href="https://www.pololu.com/docs/0J21/all#10.a">10.a. Serial slave program</a></li>
</ul>
<p>More information on the Pololu 3Pi robot</p>
<ul>
<li><a href="https://www.pololu.com/product/975">https://www.pololu.com/product/975</a></li>
</ul>
<h3 id="roam-mode">Roam Mode</h3>
<p>In roam mode the robot will</p>
<ol type="1">
<li>do a self calibration of the sensors and then follow a line for approximatly 10 seconds.</li>
<li>If the robot detects a line on both the far left and far right at the same time it will stop until power is cycled off and on. Picking the robot up will have the same effect of shutting the robot down until power is recycled.</li>
</ol>
<h3 id="no-roam-mode">No Roam Mode</h3>
<p>The purpose of no Roam Mode is to</p>
<ol type="1">
<li>Allow the robot to be programmed</li>
<li>Allow the robot batteries to be charged</li>
<li>Allow the robot to be in an interactive mode in which a USB cable and PuTTY can be used to control the robot and check sensor readings.</li>
</ol>
<p>The menu meantioned in list item 3. looks as follows:</p>
<p><img src="images/menu.png" /></p>
<h2 id="mounting-pic-xpress-board-on-3pi-expansion-board">Mounting PIC XPRESS board on 3Pi Expansion board</h2>
<h3 id="mount-1-no-longer-used">Mount 1 (no longer used)</h3>
<p>The first XPRESS board mount was forward on the 3Pi expansion board. This appeared to have a negative effect on the balance and stability of the robot. For a second mount position was tested.</p>
<p><img src="images/xpress-mount1.jpg" /></p>
<h3 id="mount-2">Mount 2</h3>
<p>For better stability the XPRESS board was moved over the wheels.</p>
<p><img src="images/expansion-mounted-2-s.jpg" /></p>
<h2 id="expansion-board-wiring">Expansion Board Wiring</h2>
<p>See <a href="wiring.html">wiring.html</a></p>
<figure>
<img src="images/expansion-schematic.png" alt="expansion-schematic.png" /><figcaption aria-hidden="true">expansion-schematic.png</figcaption>
</figure>
<h2 id="programming-3pi-robot-as-a-slave">Programming 3Pi Robot as a Slave</h2>
<p>The 3Pi Robot has an MCU on board. In APSC1299 the on board MCU will contain a program from Pololu that they call 3Pi serial slave. The MCU on the 3Pi board is wired directly to the 3Pi sensors and motor drivers. I will refer to this as the physical layer. The students will be programming the PIC18F46K42 located on the Xpress board. I will call this the executive layer. The communication between the two MCUs is via UARTs on each device. On the Xpress board it is UART1 that communicates with the robot physical layer at 115200 bps, no parity and no handshaking.</p>
<p>Programming the 3Pi Robot MCU requires a small programming board. The students will not be provided with this board as that MCU will be programmed by the technician with the following file <a href="3pi-serial-slave.hex">3pi-serial-slave.hex</a> .</p>
<h3 id="image-of-the-pololu-programmer-connected-to-the-3pi">Image of the Pololu Programmer Connected to the 3Pi</h3>
<figure>
<img src="images/programming-slave.jpg" alt="programming-slave.jpg" /><figcaption aria-hidden="true">programming-slave.jpg</figcaption>
</figure>
<h3 id="using-atmel-studio">Using Atmel Studio</h3>
<ul>
<li>Power up the 3Pi before opening Atmel Studio.</li>
<li>Open Atmel Studio</li>
<li>Tools - Device Programming</li>
</ul>
<figure>
<img src="images/atmelStudio-programming.png" alt="atmelStudio-programming.png" /><figcaption aria-hidden="true">atmelStudio-programming.png</figcaption>
</figure>
<ul>
<li>Check that the programmer is recognized before hitting apply</li>
</ul>
<figure>
<img src="images/atmelStudio-device328P.png" alt="atmelStudio-device328P.png" /><figcaption aria-hidden="true">atmelStudio-device328P.png</figcaption>
</figure>
<ul>
<li><p>click on apply</p></li>
<li><p>Memories</p></li>
<li><p>The path for the file <strong>3pi-serial-slave.hex</strong> will depend on where you save it.</p></li>
<li><p>after browsing to the file <strong>3pi-serial-slave.hex</strong> click on program.</p></li>
</ul>
<figure>
<img src="images/atmelStudio-memories.png" alt="atmelStudio-memories.png" /><figcaption aria-hidden="true">atmelStudio-memories.png</figcaption>
</figure>
<h2 id="programming-xpress-board">Programming Xpress Board</h2>
<p>This is done in the normal way over USB directly to the Xpress board. We can program the following into the Xpress boards before giving them to students. This program can also be used to test the basic function of the robot.</p>
<p><a href="xpress-pic18f46k42.3pi-basic.hex">xpress-pic18f46k42.3pi-basic.hex</a></p>
<h3 id="pololu3pi.h">pololu3pi.h</h3>
<p>This is the header file I wrote for functions that communicate with the MCU built into the robot via UART1 on the Xpress board.</p>
<p>Some improvements and changes might be made. The code can be found at <a href="https://github.com/danpeirce/xpress-pic18f46k42/tree/3pi-menu-basic1">https://github.com/danpeirce/xpress-pic18f46k42/tree/3pi-menu-basic1</a>.</p>
<p>Details on the functions listed below can be found at <a href="pololu3pi.c-details.html">pololu3pi.c-details.html</a></p>
<h4 id="contents-of-pololu3p.h">Contents of pololu3p.h</h4>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="dt">unsigned</span> <span class="dt">int</span> readbatteryvoltage(<span class="dt">void</span>);</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span class="dt">unsigned</span> <span class="dt">int</span>* readsensors(<span class="dt">void</span>);</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a><span class="dt">void</span> sendbatteryvoltage(<span class="dt">void</span>);</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a><span class="dt">void</span> send_hyphen(<span class="dt">void</span>);</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a><span class="dt">void</span> send_APSC1299(<span class="dt">void</span>);</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a><span class="dt">void</span> display_signature(<span class="dt">void</span>);</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a><span class="dt">void</span> LCD_print(<span class="dt">char</span> *str, <span class="dt">char</span> length);</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true"></a><span class="dt">void</span> foreward(<span class="dt">unsigned</span> <span class="dt">char</span> speed);</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true"></a><span class="dt">void</span> backward(<span class="dt">unsigned</span> <span class="dt">char</span> speed);</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true"></a><span class="dt">void</span> spinleft(<span class="dt">unsigned</span> <span class="dt">char</span> speed);</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true"></a><span class="dt">void</span> spinright(<span class="dt">unsigned</span> <span class="dt">char</span> speed);</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true"></a><span class="dt">void</span> LCD_line2(<span class="dt">void</span>);</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true"></a><span class="dt">void</span> sendchar(<span class="dt">char</span> a_char);</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true"></a><span class="dt">void</span> clearLCD(<span class="dt">void</span>);</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true"></a><span class="dt">void</span> calibrate(<span class="dt">void</span>);</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true"></a><span class="dt">void</span> go_pd(<span class="dt">unsigned</span> <span class="dt">char</span> speed);</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true"></a><span class="dt">void</span> stop_pd(<span class="dt">void</span>);</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true"></a><span class="dt">void</span> print_sensors(<span class="dt">void</span>);</span></code></pre></div>
<h2 id="roam-and-no-roam-shunt-jumper">Roam and No Roam Shunt Jumper</h2>
<p>The image below shows the jumper in the no roam possition. This will be changed to a switch.</p>
<p><img src="images/no_roam_s.jpg" /></p>
<h2 id="autocalibrates-when-in-roam-mode">Autocalibrates when in Roam mode</h2>
<p>Will autocalibrate the sensors if in Roam mode. For meaningful results the robot should be sitting over a black tape line. The robot will spin to the left and right sweeping the sensors over the line so that normalized readings can be calculated.</p>
<h2 id="demo">Demo</h2>
<p>Demo Video at Link</p>
<ul>
<li><a href="https://youtu.be/frrQDTKzhbE">Youtube Video Link</a></li>
</ul>
<h2 id="pull-up-on-rx2rb7">Pull up on RX2/RB7</h2>
<p>A 10 Kohm pull up resistor was added to RX2 for better reliability when USB cable is not attached.</p>
<h2 id="charging-circuit">Charging Circuit</h2>
<p>A charging circuit has been added to the expantion board. The charging circuit is just a 75 ohm resistor in series with the four AAA NiMH cells on the robot. A 9 volt external AC-DC adaptor provides power to the board.</p>
<p><img src="images/charging-sm.jpg" /></p>
<p>Showing the 75 ohm 2 watt resistor (located under the expansion board.</p>
<p><img src="images/charging-75ohm-sm.jpg" /></p>
<p><strong>Will update photos. Had to move one jumper to top side of board as it caused rubbing on right wheel. Also bend tab on barrel connector so it is flush on board before soldering.</strong></p>
<h2 id="added-print-sensor-values-to-menu">Added Print Sensor Values to menu</h2>
<p>Can now print sensor values in PuTTY when in No Roam mode. Can move robot over track by hand.</p>
<h2 id="working-with-putty-and-issues">Working with PuTTY and issues</h2>
<p>One can use a PuTTY terminal with the virtual serial port of the Xpress board. This works fine when one is typing into the terminal. There is an issue though if one attempts pasting into the PuTTY terminal (using a right mouse click). In that case only the first character is sent. This is an issue of the USB to serial bridge on the Xpress board and not the PIC code! This was verified by using a USB to serial bridge on a different board (TTLyFTDI USB-to-TTL Cable Adapter) fed into RB7. In this case the code worked as expected and all pasted characters appeared in the PuTTY terminal and were correctly sent out uart1 TX.</p>
<figure>
<img src="images/uart1-uart2.jpg" alt="uart1-uart2.jpg" /><figcaption aria-hidden="true">uart1-uart2.jpg</figcaption>
</figure>
<p>Others have commented on the limitation of the USART to USB bridge on the Xpress board:</p>
<ul>
<li><a href="https://www.microchip.com/forums/m1097510.aspx">Xpress PIC18F46K42 board virtual COM port bridge to UART receive limitations</a></li>
</ul>
<h2 id="test-of-expansion-board">Test of Expansion Board</h2>
<p>Initial testing of expansion board for 3PI.</p>
<p><img src="images/test-expansion-b.jpg" /></p>
</body>
</html>
